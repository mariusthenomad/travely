"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; } function _nullishCoalesce(lhs, rhsFn) { if (lhs != null) { return lhs; } else { return rhsFn(); } } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }var _indexjs = require('@modelcontextprotocol/sdk/server/index.js');var _typesjs = require('@modelcontextprotocol/sdk/types.js');var _zodtojsonschema = require('zod-to-json-schema'); var _zodtojsonschema2 = _interopRequireDefault(_zodtojsonschema);function y(e){try{return new URL(e),e}catch (e2){throw new Error(`invalid uri: ${e}`)}}function g(e,r){let o=new URL(e),n=new URL(r);return o.href===n.href}function x(e,r){let n=new URL(e).pathname.split("/").slice(1);for(let m of r){let s=new URL(m),t=decodeURIComponent(s.pathname).split("/").slice(1);if(n.length!==t.length)continue;let i={},c=!0;for(let a=0;a<n.length;a++){let l=t[a],R=n[a];if(!l||!R)break;if(l.startsWith("{")&&l.endsWith("}")){let p=l.slice(1,-1);if(!p)break;i[p]=R}else if(n[a]!==t[a]){c=!1;break}}if(c)return{uri:m,params:i}}}function q(e,r){return{uri:e,...r}}function I(e,r){return{uriTemplate:e,...r}}function z(e,r){return{uri:e,mimeType:"application/json",...r}}function J(e,r){return{uriTemplate:e,mimeType:"application/json",...r}}function M(e,r){return r.map(o=>{if("uri"in o){let s=new URL(o.uri,`${e}://`),t=decodeURI(s.href);return{...o,uri:t}}let n=new URL(o.uriTemplate,`${e}://`),m=decodeURI(n.href);return{...o,uriTemplate:m}})}function D(e,r){return{uri:e,mimeType:"application/json",text:JSON.stringify(r)}}function A(e){return e}function W(e){let r={};e.resources&&(r.resources={}),e.tools&&(r.tools={});let o=new (0, _indexjs.Server)({name:e.name,title:e.title,version:e.version},{capabilities:r});async function n(){if(!e.resources)throw new Error("resources not available");return typeof e.resources=="function"?await e.resources():e.resources}async function m(){if(!e.tools)throw new Error("tools not available");return typeof e.tools=="function"?await e.tools():e.tools}return o.oninitialized=async()=>{let s=o.getClientVersion(),t=o.getClientCapabilities();if(!s)throw new Error("client info not available after initialization");if(!t)throw new Error("client capabilities not available after initialization");let i={clientInfo:s,clientCapabilities:t};await _optionalChain([e, 'access', _ => _.onInitialize, 'optionalCall', _2 => _2(i)])},e.resources&&(o.setRequestHandler(_typesjs.ListResourcesRequestSchema,async()=>({resources:(await n()).filter(t=>"uri"in t).map(({uri:t,name:i,description:c,mimeType:a})=>({uri:t,name:i,description:c,mimeType:a}))})),o.setRequestHandler(_typesjs.ListResourceTemplatesRequestSchema,async()=>({resourceTemplates:(await n()).filter(t=>"uriTemplate"in t).map(({uriTemplate:t,name:i,description:c,mimeType:a})=>({uriTemplate:t,name:i,description:c,mimeType:a}))})),o.setRequestHandler(_typesjs.ReadResourceRequestSchema,async s=>{try{let t=await n(),{uri:i}=s.params,a=t.filter(u=>"uri"in u).find(u=>g(u.uri,i));if(a){let u=await a.read(i);return{contents:Array.isArray(u)?u:[u]}}let l=t.filter(u=>"uriTemplate"in u),R=l.map(({uriTemplate:u})=>y(u)),p=x(i,R);if(!p)throw new Error("resource not found");let d=l.find(u=>u.uriTemplate===p.uri);if(!d)throw new Error("resource not found");let f=await d.read(i,p.params);return{contents:Array.isArray(f)?f:[f]}}catch(t){return{isError:!0,content:[{type:"text",text:JSON.stringify({error:w(t)})}]}}})),e.tools&&(o.setRequestHandler(_typesjs.ListToolsRequestSchema,async()=>{let s=await m();return{tools:Object.entries(s).map(([t,{description:i,annotations:c,parameters:a}])=>{let l=_zodtojsonschema2.default.call(void 0, a);if(!("properties"in l))throw new Error("tool parameters must be a ZodObject");return{name:t,description:i,annotations:c,inputSchema:l}})}}),o.setRequestHandler(_typesjs.CallToolRequestSchema,async s=>{try{let t=await m(),i=s.params.name;if(!(i in t))throw new Error("tool not found");let c=t[i];if(!c)throw new Error("tool not found");let a=c.parameters.strict().parse(_nullishCoalesce(s.params.arguments, () => ({}))),l=await c.execute(a);return{content:l?[{type:"text",text:JSON.stringify(l)}]:[]}}catch(t){return{isError:!0,content:[{type:"text",text:JSON.stringify({error:w(t)})}]}}})),o}function w(e){if(!e||typeof e!="object")return e;let r={},o=["name","message"];for(let n of o)n in e&&(r[n]=e[n]);return r}var h=class{#e;#t;constructor(){let r,o,n=new Promise(s=>{r=s}),m=new Promise(s=>{o=s});this.ready=Promise.all([n,m]).then(()=>{}),this.readable=new ReadableStream({start:s=>{this.#e=s,r()}}),this.writable=new WritableStream({start:s=>{this.#t=s,o()},write:s=>{_optionalChain([this, 'access', _3 => _3.onmessage, 'optionalCall', _4 => _4(s)])}})}async start(){await this.ready}async send(r){if(!this.#e)throw new Error("readable stream not initialized");this.#e.enqueue(r)}async close(){_optionalChain([this, 'access', _5 => _5.#e, 'optionalAccess', _6 => _6.error, 'call', _7 => _7(new Error("connection closed"))]),_optionalChain([this, 'access', _8 => _8.#t, 'optionalAccess', _9 => _9.error, 'call', _10 => _10(new Error("connection closed"))]),_optionalChain([this, 'access', _11 => _11.onclose, 'optionalCall', _12 => _12()])}};exports.StreamTransport = h; exports.createMcpServer = W; exports.jsonResource = z; exports.jsonResourceResponse = D; exports.jsonResourceTemplate = J; exports.resource = q; exports.resourceTemplate = I; exports.resources = M; exports.tool = A;
//# sourceMappingURL=index.cjs.map